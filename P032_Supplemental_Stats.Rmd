---
title: "P032a Supplemental Statistics"
author: "cyruskirkman"
date: "2024-03-13"
---

```{r setup, include=FALSE}
# Install libraries
#install.packages("viridis")
#install.packages("ggpubr")
#install.packages("tidyverse")
# if(!require(devtools)) install.packages("devtools")
#devtools::install_github("kassambara/ggpubr", force = TRUE)
#install.packages("bookdown")
#install.packages("kableExtra")

# Import libraries
library(BayesFactor)
library(betareg)
library(binom)
library(bookdown)
library(broom)
library(cowplot)
library(equivalence)
library(fs) # for importing multiple csvs
library(gganimate)
library(ggimage)
library(gapminder)
library(ggpattern)
library(ggplot2)
library(ggpubr) 
library(ggthemes)
library(hms) # For importing datetime objects as TOD w/ decimals
library(kableExtra)
library(knitr)
library(lubridate) # for dealing with time objects
library(magick)
library(plotly) # for medians
library(readr) # This lib is used to combine .csvs
library(scales) # for time scales
library(slider)
library(stargazer)
library(tidyr)
library(tidyverse)
library(viridis)
library(zoo)

set.seed(33) 
```

This is a document containing most of the summarative/inferential statistics and
graphics of the three experiments  of P032a--the insight experiment. It has
been written in a R markdown document and knitted into a html document. It also
can be converted into a neat .pdf using LaTex libraries.

Some of these analyses were used in the manuscript, but a majority are
additional analyses and graphics used to better understand/visualize our trends. 

One major thing to note here is that the nomenclature of our training phases did
not align with the publication data; for example, the publication's Phase 2B 
translates to 5.b in our data. However, translations are provided in headers 
and titles of graphics & tables.

```{r import_data, echo=FALSE, message=FALSE, warning=FALSE}

# This function helps make y-axes mark at integers, not decimals (relevant
# for session breaks in graphics)
integer_breaks <- function(n = 5, ...) {
  fxn <- function(x) {
    breaks <- floor(pretty(x, n, ...))
    names(breaks) <- attr(breaks, "labels")
    breaks
  }
  return(fxn)
}

# Function to perform permutation test for EXP/RWM comparison
perm_test <- function(data1, data2) {
  combined_data <- c(data1, data2)
  permuted_data <- sample(combined_data)
  permuted_mean_diff <- mean(permuted_data[1:length(data1)]) - mean(permuted_data[(length(data1) + 1):length(combined_data)])
  return(permuted_mean_diff)
}

# This imports a combined data set as a tibble using read_csv() and manipulates
# the data in a couple key ways.
combined_data <- read_csv("/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/Summary Data/Combined_Data/P032a_Cleaned-and-Combined-data_2023-11-15.csv",
              col_types = cols(Time = col_character(),
                               TrialTime = col_character()
                               )
              ) %>% 
  mutate(Time = as_hms(Time),
         TrialTime = as_hms(TrialTime))%>% 
  # Remove any data not relevant to these analyses (e.g., omit any spatial data
  # or temporary data created above) for ease of running in the future.
  dplyr::select(Date, Time, EventType, TrialNum, MoveCounter, TrialPar, TrialTime,
         Subject, TrainingPhase, InsightTrialType)

         # TrialPar = ifelse(InsightTrialType == "7.4",
         #                   4,
         #                   TrialPar)) %>% 

# This is a temporary random walk model function for 3.b TEST and 3.d TEST
# n = subjects. probability = number of options, sessions = sessions
random_walk_model <- function(n = 10, prob = 4,
                              sessions = 3, banks = 1) {
  # c <- 0 # counter
  df1 <- data.frame() # To be added to later...
  # Our while loop (to be run for n number of subjects)
  for (subj in c(1:n)) {
    for (session in c(1:sessions)) {
      max_reinforced_trials <- 90
      reinforced_trial_counter <- 0
      total_trials <- 1
      while (reinforced_trial_counter < max_reinforced_trials) {
        rand_order <- sample(1:prob)
        if (rand_order[1] == prob) {
          outcome = "reinforcement"
          reinforced_trial_counter <- reinforced_trial_counter + 1
        } else {
          outcome = "TimeOutPeriod"
        }
        # Make new df (row)
        r1 <- data.frame("Subject" = subj,
                         "SessionNum" = session,
                         "TrialNum" = total_trials,
                         "EventType" = outcome)
        # Append to the existing one
        df1 <- rbind(df1, r1)
        total_trials <- total_trials + 1
        print(total_trials)
      }
    }
  }
  
  df1 %>% 
    group_by(Subject, SessionNum) %>% 
    mutate(BankNum = ceiling(TrialNum / (max(TrialNum) / banks)) + ((SessionNum - 1) * banks)) %>% 
    filter(EventType %in% c("reinforcement", "TimeOutPeriod")) %>%
    group_by(Subject, BankNum) %>% # For every bank
    mutate(TotalTrialsPerBank = n()) %>% 
    filter(EventType %in% c("reinforcement")) %>%
    mutate(RatioCorrectPerBank = n() / TotalTrialsPerBank)
}


```

# Experiment 1 - Pre-training & Training of Directional Movement
## Phases 1A & 1B
1A was a fixed position pacman requiring a single peck; 1B was a variable
position. Phases were combined for concision's sake.  

### Phase 1A & 1B Information
```{r 1A_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("1.a")) %>%
  # By subject info
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1A Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1B_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("1.b")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1B Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### 1A & 1B Pecking accuracy
```{r 1A&1B_first_session_pecking_accuracy, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked",
                          "BackgroundPeck"),
         TrainingPhase %in% c("1.a", "1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  group_by(Subject, SessionNum) %>% 
  mutate(IfPacmanPeck = ifelse(EventType %in% c("PacmanPecked", "pacmanPecked"),
                               1,
                               0),
         PeckingAccuracy = mean(IfPacmanPeck)) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  filter(SessionNum == 1) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofAccuracy = mean(PeckingAccuracy),
         SDofAccuracy = sd(PeckingAccuracy)) %>% 
  select(Subject, PeckingAccuracy, SessionNum, PeckingAccuracy, MeanofAccuracy, SDofAccuracy) %>%
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1A & 1B First Session Pecking Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1A&1B_terminal_trial_pecking_accuracy, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked",
                          "BackgroundPeck"),
         TrainingPhase %in% c("1.a", "1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  group_by(Subject, SessionNum) %>% 
  mutate(IfPacmanPeck = ifelse(EventType %in% c("PacmanPecked", "pacmanPecked"),
                               1,
                               0),
         PeckingAccuracy = mean(IfPacmanPeck)) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  filter(SessionNum == MaxSession) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofAccuracy = mean(PeckingAccuracy),
         SDofAccuracy = sd(PeckingAccuracy)) %>% 
  select(Subject, PeckingAccuracy, SessionNum, PeckingAccuracy, MeanofAccuracy, SDofAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1A & 1B Terminal SessionPecking Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1A&1B_beta_reg_pecking_accuracy, echo=FALSE}
# summary(
#   combined_data %>%
#   filter(EventType %in% c("pacmanPecked",
#                           "PacmanPecked",
#                           "BackgroundPeck"),
#          TrainingPhase %in% c("1.a", "1.b")) %>%
#   # Assign a session number to each and find max
#   group_by(Subject) %>% 
#   mutate(SessionNum = dense_rank(Date)) %>%
#   group_by(Subject, SessionNum) %>% 
#   mutate(IfPacmanPeck = ifelse(EventType %in% c("PacmanPecked", "pacmanPecked"),
#                                1,
#                                0),
#          PeckingAccuracy = mean(IfPacmanPeck)) %>% 
#     
#   ungroup() %>% 
#   select(Subject, SessionNum, PeckingAccuracy) %>% 
#   glm(PeckingAccuracy ~ SessionNum, 
#               data = .)
# )
summary(
  combined_data %>%
    filter(EventType %in% c("pacmanPecked", "PacmanPecked", "BackgroundPeck"),
           TrainingPhase %in% c("1.a", "1.b")) %>%
    # Assign a session number to each and find max
    group_by(Subject) %>% 
    mutate(SessionNum = dense_rank(Date)) %>%
    group_by(Subject, SessionNum) %>% 
    mutate(IfPacmanPeck = ifelse(EventType %in% c("PacmanPecked", "pacmanPecked"), 1, 0),
           PeckingAccuracy = mean(IfPacmanPeck)) %>% 
    # Adjust extreme values of 0 & 1 to avoid infinite log-likelihood values
    mutate(PeckingAccuracy = ifelse(PeckingAccuracy == 0,
                                    0.0001, 
                                   ifelse(PeckingAccuracy == 1,
                                          0.9999,
                                          PeckingAccuracy))) %>% 
    ungroup() %>% 
    select(Subject, SessionNum, PeckingAccuracy) %>% 
    betareg(PeckingAccuracy ~ SessionNum, 
            data = .)
)
```
```{r 1A_first_vs_terminal_session_pecking_accuracy_graphic, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked",
                          "BackgroundPeck"),
         TrainingPhase %in% c("1.a")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  group_by(Subject, WhichSession) %>% 
  mutate(IfPacmanPeck = ifelse(EventType %in% c("PacmanPecked", "pacmanPecked"),
                               1,
                               0),
         SubjectPeckingAccuracy = mean(IfPacmanPeck,
                                       na.rm = TRUE)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanofAccuracy = mean(SubjectPeckingAccuracy),
         SDofAccuracy = sd(SubjectPeckingAccuracy)) %>% 
  ungroup() %>% 
  ggplot(aes(x = WhichSession,
             y = SubjectPeckingAccuracy,
             group = Subject)) +
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanofAccuracy)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.A Mean Pecking Accuracy",
       y = "Pacman / Total Pecks",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (20))
  ) +
    scale_x_discrete(expand = c(0.1, 0.15))
```
```{r 1B_first_vs_terminal_session_pecking_accuracy_graphic, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked",
                          "BackgroundPeck"),
         TrainingPhase %in% c("1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  group_by(Subject, WhichSession) %>% 
  mutate(IfPacmanPeck = ifelse(EventType %in% c("PacmanPecked", "pacmanPecked"),
                               1,
                               0),
         SubjectPeckingAccuracy = mean(IfPacmanPeck,
                                       na.rm = TRUE)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanofAccuracy = mean(SubjectPeckingAccuracy),
         SDofAccuracy = sd(SubjectPeckingAccuracy)) %>% 
  ungroup() %>% 
  ggplot(aes(x = WhichSession,
             y = SubjectPeckingAccuracy,
             group = Subject)) +
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanofAccuracy)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.B Mean Pecking Accuracy",
       y = "Pacman / Total Pecks",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (20))
  ) +
    scale_x_discrete(expand = c(0.1, 0.1))
```
### 1A & 1B Trial Latency
```{r 1A&1B_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.a", "1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)
         ) %>%
  # Calculate MeanTrialLatencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8)) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = mean(TrialLatency,
                        na.rm = TRUE)) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  ungroup() %>% 
  # Calculate Group MeanTrialLatencies
  mutate(GroupMeanTrialLatency = mean(MeanTrialLatency,
                    na.rm = TRUE),
         sdMeanTrialLatency = sd(MeanTrialLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanTrialLatency, GroupMeanTrialLatency, sdMeanTrialLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1A & 1B First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1A&1B_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.a", "1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)
         ) %>%
  # Calculate MeanTrialLatencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8)) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = mean(TrialLatency,
                        na.rm = TRUE)) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  ungroup() %>% 
  # Calculate Group MeanTrialLatencies
  mutate(GroupMeanTrialLatency = mean(MeanTrialLatency,
                    na.rm = TRUE),
         sdMeanTrialLatency = sd(MeanTrialLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanTrialLatency, GroupMeanTrialLatency, sdMeanTrialLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1A & 1B First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
No effect of the linear GLM across both 1A and 1B combined trial latency b/c 
of the multi-modal distribution (specifically a peak at the start of 1B)
```{r 1A&1B_trial_completion_time_GLM, echo=FALSE}
summary(
  combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.a", "1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate IRTs
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, MeanTrialLatency, SessionNum) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)
```
```{r 1A_first_vs_terminal_session_mean_trial_latency_graphic, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.a")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 100,
                               100,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanTrialLatency,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanOfMeanTrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.A Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (20))
  ) +
    scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1A_first_vs_terminal_session_all_trial_latencies, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.a")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 100,
                               100,
                               TrialLatency)) %>% # Cap any trials 2.5 minutes or longer at 2.5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanOfMeanTrialLatency)) + 
  geom_violin(aes(y = TrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.A Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.title = element_text(family = "Times", size = (10)),
    axis.text = element_text(family = "Times", face = "italic", size = (10))
    )
```
```{r 1B_first_vs_terminal_session_mean_trial_latency_graphic, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 100,
                               100,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanTrialLatency,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanOfMeanTrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.B Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (20))
  ) +
    scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1B_first_vs_terminal_session_all_trial_latencies, echo=FALSE}
combined_data %>%
  filter(EventType %in% c("pacmanPecked",
                          "PacmanPecked"),
         TrainingPhase %in% c("1.b")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 100,
                               100,
                               TrialLatency)) %>% # Cap any trials 2.5 minutes or longer at 2.5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanOfMeanTrialLatency)) + 
  geom_violin(aes(y = TrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.B Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.title = element_text(family = "Times", size = (10)),
    axis.text = element_text(family = "Times", face = "italic", size = (10))
    )
```


## Phases 1C & 1D
1C introduced a single cursor (no banana); 1D had four cursor options  

### Phase 1C & 1D Information
```{r 1C_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.a")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  dplyr::select(Subject, NumSessions) %>% 
  kable(format = "html",
      caption = "1C Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1D_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.b")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  dplyr::select(Subject, NumSessions) %>% 
  kable(format = "html",
      caption = "1D Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### Phase 1C Trial Latency
```{r 1C_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.a"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8.5) %>%   # Account for 3.5s feed + 5s ITI
  filter(TrialLatency < 300) %>%  # Remove any trials 5 minutes or longer
  mutate(MeanLatency = mean(TrialLatency,
                            na.rm = TRUE)) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  kable(format = "html",
      caption = "1C First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1C_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.a"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  kable(format = "html",
      caption = "1C First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1C_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("2.a"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanTrialLatency) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)

```
```{r 1C_first_vs_terminal_session_mean_trial_latency_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.a"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time)))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 100,
                               100,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanTrialLatency,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanOfMeanTrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.C Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (20))
  ) +
    scale_x_discrete(expand = c(0.1, 0.1))
```

### Phase 1D Trial Latency
```{r 1D_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.b"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  kable(format = "html",
      caption = "1D First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1D_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.b"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  kable(format = "html",
      caption = "1D First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1D_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("2.b"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanTrialLatency) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)

```
```{r 1D_first_vs_terminal_session_mean_trial_latency, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.b"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanTrialLatency,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanOfMeanTrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.D Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1D_first_vs_terminal_session_all_trial_latencies, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("2.b"),
         EventType %in% c("east_oval_pacman",
                          "west_oval_pacman",
                          "south_oval_pacman",
                          "north_oval_pacman")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanOfMeanTrialLatency)) + 
  geom_violin(aes(y = TrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.D Pooled Trial Latencies",
       y = "Trial Duration (s)",
       x = "Session") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
```

## Phases 1E, 1F, 1F.Test, 1G, 1H, & 1H.Test
1E - Single cursor, one-move banana (no wrong choices)  
1F - Multi cursor, one-move banana (punished choices)  
1F.Test - Multi cursor, one-move banana (open task)  
1G - Single cursor, two-move banana (no wrong choices)  
1H - Multi cursor, two-move banana (punished choices)  
1H.Test - Multi cursor, two-move banana (open task)  

### Phase 1E
Trial Latency only
```{r 1E_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.a")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>%
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1E Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1E_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1E First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1E_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Individual trial latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  ungroup() %>%
  # Calculate group trial latencies
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1E Terminal Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1E_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("3.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanTrialLatency) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)

```
```{r 1E_first_vs_terminal_session_mean_trial_latency, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanTrialLatency,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanOfMeanTrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.E Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1E_first_vs_terminal_session_all_trial_latencies, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanOfMeanTrialLatency)) + 
  geom_violin(aes(y = TrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.E Pooled Trial Latencies",
       y = "Trial Duration (s)",
       x = "Session") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
```
### Phase 1F
```{r 1F_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### Phase 1F Accuracy
```{r 1F_first_session_accuracy, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  filter(SessionNum == 1) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>%
  ungroup() %>% 
  
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  # Build table
  select(Subject, SessionNum, SessionAccuracy, MeanSessionAccuracy,
         sdSessionAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F First Session Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1F_terminal_session_accuracy, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  filter(SessionNum == MaxSession) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>%
  ungroup() %>% 
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  # Build table
  select(Subject, SessionNum, SessionAccuracy, MeanSessionAccuracy,
         sdSessionAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F Terminal Session Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1F_beta_reg_by_session_accuracy, echo=FALSE}
# summary(
#   combined_data %>%
#   filter(TrainingPhase %in% c("3.b"),
#          EventType %in% c("reinforcement",
#                           "TimeOutPeriod")
#          ) %>%
#   # Assign a session number to each and find max
#   group_by(Subject) %>% 
#   mutate(SessionNum = dense_rank(Date),
#          MaxSession = max(SessionNum),
#          Correct = ifelse(EventType == "reinforcement",
#                           1,
#                           0)
#          ) %>% 
#   group_by(Subject, SessionNum) %>% 
#   mutate(SessionAccuracy = mean(Correct)) %>% 
#   filter(row_number() == 1) %>%
#   # Build table
#   select(Subject, SessionNum, SessionAccuracy) %>% 
#   glm(SessionAccuracy ~ SessionNum, 
#               data = .)
# )
summary(
  combined_data %>%
    filter(TrainingPhase %in% c("3.b"),
           EventType %in% c("reinforcement", "TimeOutPeriod")) %>%
    # Assign a session number to each and find max
    group_by(Subject) %>% 
    mutate(SessionNum = dense_rank(Date),
           MaxSession = max(SessionNum),
           Correct = ifelse(EventType == "reinforcement", 1, 0)) %>% 
    group_by(Subject, SessionNum) %>% 
    mutate(SessionAccuracy = mean(Correct)) %>% 
    filter(row_number() == 1) %>%
    # Adjust extreme values of 0 & 1 to avoid infinite log-likelihood values
    mutate(SessionAccuracy = ifelse(SessionAccuracy == 0, 0.0001, 
                                    ifelse(SessionAccuracy == 1, 0.9999, SessionAccuracy))) %>% 
    ungroup() %>% 
    select(Subject, SessionNum, SessionAccuracy) %>% 
    betareg(SessionAccuracy ~ SessionNum, 
            data = .)
)
```
```{r 1F_by_session_accuracy_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1,
         !SessionAccuracy %in% c(0,1)) %>%
  ungroup() %>% 
  # Group means
  group_by(SessionNum) %>% 
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  ggplot(aes(x = SessionNum,
             y = SessionAccuracy,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanSessionAccuracy)) +
  geom_hline(yintercept = 0.35,
             linetype = "dashed") + # Chance
  ylim(0,1)+
  # Aesthetics
  theme_classic() +
  labs(title = "1.F Mean Session Accuracy",
       y = "Correct / Total Trials",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 1F_by_session_range_accuracy_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1,
         !SessionAccuracy %in% c(0,1)) %>% # Remove mislabeled sessions w/ 0% or 100% accuracy
  ungroup() %>% 
  # Group means
  group_by(SessionNum) %>% 
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy),
         MinAccuracy = min(SessionAccuracy),
         MaxAccuracy = max(SessionAccuracy)) %>% 
  ggplot(aes(x = SessionNum)) + 
  geom_ribbon(aes(ymin = MinAccuracy,
                ymax = MaxAccuracy),
              alpha = 0.8,
              fill = "darkseagreen4") +
  geom_line(aes(y = MeanSessionAccuracy)) + 
  geom_hline(yintercept = 0.35,
             linetype = "dashed") + # Chance
  ylim(0,1)+
  # Aesthetics
  theme_classic() +
  labs(title = "1.F Range of Mean Session Accuracy",
       y = "Correct / Total Trials",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 1F_ttest_terminal_accuracy, echo=FALSE}
print(
  combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  group_by(Subject, Date) %>% 
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct,
                                na.rm = TRUE)) %>% 
  filter(row_number() == 1) %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == MaxSession) %>% 
  # Run ttest
  ungroup() %>% 
  select(SessionAccuracy) %>% 
  t.test(., mu = 0.35)
)


```

#### Phase 1F Trial Latency
```{r 1F_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>%
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1F_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Individual trial latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  ungroup() %>%
  # Calculate group trial latencies
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F Terminal Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1F_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("3.b"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time), 
         MeanTrialLatency = as.numeric(mean(TrialLatency,
                                   na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanTrialLatency) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)
```
### Phase 1F.Test
```{r 1F.Test_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b.Test")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F.Test Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1F.Test_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b.Test"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par of 1
  ungroup() %>% 
  # Subject Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1F.Test SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1F.Test_SAP_GLM, echo=FALSE}
# GLM of SAP over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("3.b.Test"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Variable par
  ungroup() %>% 
  select(Subject, SessionNum, SAP) %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)


```
```{r 1F.Test_SAP_violin_graphic, echo=FALSE}
# combined_data %>%
#   filter(TrainingPhase %in% c("3.b.Test"),
#          EventType %in% c("reinforcement")
#          ) %>%
#   # Assign a session number to each and find max
#   group_by(Subject) %>% 
#   mutate(SessionNum = dense_rank(Date)) %>% 
#   # Find SAP for each trial...
#   group_by(Subject, SessionNum, TrialNum) %>% 
#   mutate(SAP = MoveCounter - 1) %>% # Par of 1
#   ungroup() %>% 
#   # Subject Means
#   group_by(Subject, SessionNum) %>% 
#   mutate(MeanSAP = mean(SAP),
#          sdSAP = sd(SAP)) %>% 
#   #filter(row_number() == 1) %>% # Grab one data point for each subject
#   ungroup() %>% 
#   group_by(SessionNum) %>% 
#   mutate(GroupMeanSAP = mean(MeanSAP),
#        GroupsdSAP = sd(MeanSAP)) %>% 
#   # Build graphic
#   ggplot() +
#   geom_violin(data = random_walk_model(prob = 4,
#                                     sessions = 6,
#                                     n = 10)
#               ) +
#   geom_violin(aes)
#   geom_jitter(alpha = 0.3,
#               size = 0.5) +
#   # Aesthetics
#   theme_classic() +
#   labs(title = "1.F Test SAP",
#        y = "Steps Above Par (SAP)",
#        x = "Session") +
#   theme(
#     plot.title = element_text(family = "Times", face = "bold", size = (20)),
#     axis.title = element_text(family = "Times", size = (20)),
#     axis.text = element_text(family = "Times", face = "italic", size = (15))
#   ) +
#   scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1F.Test_SAP_first_vs_terminal_session_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.b.Test"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Find SAP for each trial...
  group_by(Subject, WhichSession, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par of 1
  ungroup() %>% 
  # Subject Means
  group_by(Subject, WhichSession) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  #filter(row_number() == 1) %>% # Grab one data point for each subject
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build graphic
  ggplot(aes(x = WhichSession)) + 
  geom_line(aes(y = MeanSAP,
                group = Subject),
            color = "gray",
            alpha = 0.5
            )+
  geom_line(aes(y = GroupMeanSAP,
                group = 1)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.F Test SAP",
       y = "Mean SAP",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  ) +
  scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1F.Test_RWM_SAP_graphic, echo=FALSE}
OneF_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/3.b_Test_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("3.b.Test"),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 2) %>% # Par of 2
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  # # Subject Means
  # group_by(Subject) %>% 
  # mutate(MeanSAP = mean(SAP),
  #        sdSAP = sd(SAP)) %>% 
  # filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  # ungroup() %>% 
  # mutate(GroupMeanSAP = mean(MeanSAP),
  #      GroupsdSAP = sd(MeanSAP)) %>% 
  # ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = OneF_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = OneF_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "1.F Test: Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  ) +
  scale_x_discrete(expand = c(0.1, 0.1))
  
```
```{r 1F.Test_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- "3.b.Test"
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/3.b_Test_simulated_RWM_data.csv"
phase_par <- 1

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Select terminal session of phase
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  filter(SessionNum == MaxSession) %>% 
  ungroup() %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path,
                     show_col_types = FALSE) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == MaxSession) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - phase_par)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```

### Phase 1G
Trial Latency only
```{r 1G_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.c")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  dplyr::select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1G Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1G_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.c"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1G First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1G_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.c"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Individual trial latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  ungroup() %>%
  # Calculate group trial latencies
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1G Terminal Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1G_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("3.c"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanTrialLatency) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)

```
```{r 1G_first_vs_terminal_session_mean_trial_latency, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.c"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = MeanTrialLatency,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanOfMeanTrialLatency)) +
  # Aesthetics
  theme_classic() +
  labs(title = "1.G Mean Trial Latency",
       y = "Mean Trial Duration (s)",
       x = "Session") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 1G_first_vs_terminal_session_all_trial_latencies, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.c"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Calculate Trial Latencies
  group_by(Subject, WhichSession) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = as.numeric(Time - lag(Time) - 8))%>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,
                               300,
                               TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanTrialLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  # filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(MeanOfMeanTrialLatency = mean(MeanTrialLatency,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  # Then plot...
  ggplot(aes(x = WhichSession,
             y = TrialLatency)) + 
  geom_violin() +
  geom_jitter(alpha = 0.3,
              size = 0.5) +
  
  # Aesthetics
  theme_classic() +
  labs(title = "1.G Pooled Trial Latencies",
       y = "Trial Duration (s)",
       x = "Session") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
```
### Phase 1H
```{r 1H_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  dplyr::select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### Phase 1H Accuracy
```{r 1H_first_session_accuracy, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  filter(SessionNum == 1) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>%
  ungroup() %>% 
  
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  # Build table
  select(Subject, SessionNum, SessionAccuracy, MeanSessionAccuracy,
         sdSessionAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H First Session Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1H_terminal_session_accuracy, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  filter(SessionNum == MaxSession) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>%
  ungroup() %>% 
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  # Build table
  select(Subject, SessionNum, SessionAccuracy, MeanSessionAccuracy,
         sdSessionAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H Terminal Session Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1H_GLM_by_session_accuracy, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>%
  # Build table
  select(Subject, SessionNum, SessionAccuracy) %>% 
  glm(SessionAccuracy ~ SessionNum, 
              data = .)
)
```
```{r 1H_by_session_accuracy_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1,
         !SessionAccuracy %in% c(0,1)) %>%
  ungroup() %>% 
  # Group means
  group_by(SessionNum) %>% 
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  ggplot(aes(x = SessionNum,
             y = SessionAccuracy,
             group = Subject)) + 
  geom_line(color = "gray",
            alpha = 0.5) +
  geom_line(aes(y = MeanSessionAccuracy)) +
  geom_hline(yintercept = 0.1225,
             linetype = "dashed") + # Chance
  ylim(0,1)+
  # Aesthetics
  theme_classic() +
  labs(title = "1.H Mean Session Accuracy",
       y = "Correct / Total Trials",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 1H_by_session_range_accuracy_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         Correct = ifelse(EventType == "reinforcement",
                          1,
                          0)
         ) %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1,
         !SessionAccuracy %in% c(0,1)) %>% # Remove mislabeled sessions w/ 0% or 100% accuracy
  ungroup() %>% 
  # Group means
  group_by(SessionNum) %>% 
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy),
         MinAccuracy = min(SessionAccuracy),
         MaxAccuracy = max(SessionAccuracy)) %>% 
  ggplot(aes(x = SessionNum)) + 
  geom_ribbon(aes(ymin = MinAccuracy,
                ymax = MaxAccuracy),
              alpha = 0.8,
              fill = "darkseagreen4") +
  geom_line(aes(y = MeanSessionAccuracy)) + 
  geom_hline(yintercept = 0.1225,
             linetype = "dashed") + # Chance
  ylim(0,1)+
  # Aesthetics
  theme_classic() +
  scale_x_continuous(breaks = integer_breaks()) +
  labs(title = "1. Range of Mean Session Accuracy",
       y = "Correct / Total Trials",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 1H_ttest_terminal_accuracy, echo=FALSE}
print(
  combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  group_by(Subject, Date) %>% 
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct,
                                na.rm = TRUE)) %>% 
  filter(row_number() == 1) %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == MaxSession) %>% 
  # Run ttest
  ungroup() %>% 
  select(SessionAccuracy) %>% 
  t.test(., mu = 0.1225)
)


```

#### Phase 1H Trial Latency
```{r 1H_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1H_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Individual trial latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time) - 8) %>%  # Account for 3s feed + 5s ITI
  mutate(TrialLatency = ifelse(TrialLatency > 300,                                300,                                TrialLatency)) %>% # Cap any trials 5 minutes or longer at 5 min
  mutate(MeanLatency = as.numeric(mean(TrialLatency,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select terminal session
  ungroup() %>%
  # Calculate group trial latencies
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H Terminal Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1H_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("3.d"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Trial Latencies
  group_by(Subject, SessionNum) %>% 
  arrange(Time) %>%
  mutate(TrialLatency = Time - lag(Time), 
         MeanTrialLatency = as.numeric(mean(TrialLatency,
                                   na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanTrialLatency) %>% 
  glm(MeanTrialLatency ~ SessionNum, 
              data = .)
)
```
### Phase 1H.Test
```{r 1H.Test_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d.Test")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H.Test Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1H.Test_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("3.d.Test"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 2) %>% # Par of 2
  ungroup() %>% 
  # Subject Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1H.Test SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1H.Test_RWM_SAP_graphic, echo=FALSE}
OneH_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/3.d_Test_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("3.d.Test"),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 2) %>% # Par of 2
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  # # Subject Means
  # group_by(Subject) %>% 
  # mutate(MeanSAP = mean(SAP),
  #        sdSAP = sd(SAP)) %>% 
  # filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  # ungroup() %>% 
  # mutate(GroupMeanSAP = mean(MeanSAP),
  #      GroupsdSAP = sd(MeanSAP)) %>% 
  # ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = OneH_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = OneH_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "1.H Test: Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  ) +
  scale_x_discrete(expand = c(0.1, 0.1))
  
```
```{r 1H.Test_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- "3.d.Test"
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/3.d_Test_simulated_RWM_data.csv"
phase_par <- 2

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Select terminal session of phase
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  filter(SessionNum == MaxSession) %>% 
  ungroup() %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path,
                     show_col_types = FALSE) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == MaxSession) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - phase_par)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```


## Phases 1I 1I.Test, & 1J
### Phase 1I
```{r 1I_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test")) %>% 
  # First up we need to differentiate 4.a sessions from test b/c
  # there are some inconsistencies across the way files are named
  group_by(Subject, Date) %>% 
  # Take out any sessions with more than 2 moves, as these are 4.a.Test sessions
  filter(max(TrialNum) > 5,  # Take out sessions with fewer than 5 trials
        any(EventType == "TimeOutPeriod")) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### Phase 1I Accuracy
```{r 1I_first_session_accuracy, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  group_by(Subject, Date) %>% 
  # Take out any sessions with more than 2 moves, as these are 4.a.Test sessions
  filter(max(TrialNum) > 5,  # Take out sessions with fewer than 5 trials
        any(EventType == "TimeOutPeriod")) %>% 
  # Next we can determine the accuracy each session
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct)) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  # Assign session numbers...
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == 1, # Select only first session
         row_number() == 1) %>%
  ungroup() %>% 
  # We can grab group means now
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  # Build table
  select(Subject, SessionNum, SessionAccuracy, MeanSessionAccuracy,
         sdSessionAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I First Session Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1I_terminal_session_accuracy, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  group_by(Subject, Date) %>% 
  # Take out any sessions with more than 2 moves, as these are 4.a.Test sessions
  filter(max(TrialNum) > 5,  # Take out sessions with fewer than 5 trials
        any(EventType == "TimeOutPeriod")) %>% 
  # Next we can determine the accuracy each session
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct)) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  # Assign session numbers...
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == MaxSession, # Select only terminal session
         row_number() == 1) %>%
  ungroup() %>% 
  # We can grab group means now
  mutate(MeanSessionAccuracy = mean(SessionAccuracy),
         sdSessionAccuracy = sd(SessionAccuracy)) %>% 
  # Build table
  select(Subject, SessionNum, SessionAccuracy, MeanSessionAccuracy,
         sdSessionAccuracy) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I Terminal Session Accuracy") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1I_GLM_by_session_accuracy, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # First up we need to differenitiate 4.a sessions from test b/c
  # there are some inconsistencies across the way files are named
  group_by(Subject, Date) %>% 
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct)) %>% 
  # Next take out any sessions with more than 2 moves, as these are 4.a.Test sessions
  filter(max(MoveCounter, na.rm = FALSE) == 2) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>%
  # Build glm
  select(Subject, SessionNum, SessionAccuracy) %>% 
  glm(SessionAccuracy ~ SessionNum, 
              data = .)
)
```
```{r 1I_ttest_terminal_accuracy, echo=FALSE}
print(
  combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # First up we need to differentiate 4.a sessions from test b/c
  # there are some inconsistencies across the way files are named
  group_by(Subject, Date) %>% 
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct)) %>% 
  # Next take out any sessions with more than 2 moves, as these are 4.a.Test sessions
  filter(max(MoveCounter, na.rm = FALSE) == 2) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         SessionAccuracy = mean(Correct)) %>% 
  filter(row_number() == 1) %>% 
  # Run ttest
  ungroup() %>% 
  select(SessionAccuracy) %>% 
  t.test(., mu = 0.07107556)
)


```
#### Phase 1I Trial Latency
```{r 1I_first_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  filter(TrialTime < 300) %>% # Remove any trials 5 minutes or longer
  mutate(MeanLatency = as.numeric(mean(TrialTime,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == 1) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I First Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1I_terminal_session_trial_completion_time, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  filter(TrialTime < 300) %>% # Remove any trials 5 minutes or longer
  mutate(MeanLatency = as.numeric(mean(TrialTime,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1,
         SessionNum == MaxSession) %>% # Select first session
  # Calculate Group Trial Latencies
  ungroup() %>% 
  mutate(GroupMeanLatency = mean(MeanLatency,
                    na.rm = TRUE),
         sdGroupLatency = sd(MeanLatency, 
                    na.rm = TRUE)) %>% 
  # Build table
  select(Subject, SessionNum, MeanLatency, GroupMeanLatency, sdGroupLatency) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I Terminal Session Trial Latencies") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1I_trial_completion_time_GLM, echo=FALSE}
# GLM of MeanTrialLatency over time across all subjects
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("4.a"),
         EventType == "BananaReached"
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  # Calculate Subject Trial Latencies
  group_by(Subject, SessionNum) %>% 
  filter(TrialTime < 300) %>% # Remove any trials 5 minutes or longer
  mutate(MeanLatency = as.numeric(mean(TrialTime,
                        na.rm = TRUE))
         ) %>% 
  filter(row_number() == 1) %>% # Select one data point from each subject/session
  select(Subject, SessionNum, MeanLatency) %>% 
  glm(MeanLatency ~ SessionNum, 
              data = .)
)
```
### Phase 1I.Test
```{r 1I.Test_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test"),
         EventType %in% c("reinforcement",
                          "TimeOutPeriod")
         ) %>%
  # First up we need to differenitiate 4.a sessions from test b/c
  # there are some inconsistencies across the way files are named
  group_by(Subject, Date) %>% 
  mutate(Correct = ifelse(EventType == "reinforcement",
                          1,
                          0),
         SessionAccuracy = mean(Correct)) %>% 
  # Only include sessions with 100% accuracy, as these are 4.a.Test sessions
  filter(SessionAccuracy == 1) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  dplyr::select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I.Test Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1I.Test_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5,  # Take out sessions with fewer than 5 trials
      !any(EventType == "TimeOutPeriod")) %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 2) %>% # Par of 2
  ungroup() %>% 
  # Subject Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1I.Test SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1I.Test_RWM_SAP_graphic, echo=FALSE}

OneI_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/4.a_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:3)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("4.a", "4.a.Test"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5,  # Take out sessions with fewer than 5 trials
      !any(EventType == "TimeOutPeriod")) %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 2) %>% # Par of 2
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = OneI_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = OneI_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "1.I Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
      plot.title = element_text(family = "Times", face = "bold", size = (20)),
      axis.title = element_text(family = "Times", size = (20)),
      axis.text = element_text(family = "Times", face = "italic", size = (20))
    ) +
      scale_x_discrete(expand = c(0.1, 0.1))
  
```
```{r 1I.Test_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- c("4.a", "4.a.Test")
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/4.a_simulated_RWM_data.csv"
phase_par <- 2

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% exp_phase,
         EventType %in% c("BananaReached")
         ) %>%
  # Select first session of phase
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  filter(SessionNum == 1) %>% 
  ungroup() %>% 
  mutate(SAP = MoveCounter - phase_par) %>% 
  filter(SAP >= 0) %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path,
                     show_col_types = FALSE) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% exp_phase,
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == 1) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - phase_par) %>% 
  filter(SAP >= 0)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```

### Phase 1.J
```{r 1J_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.b")) %>%
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1J Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1J_first_session_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == 1) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1J First Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1J_terminal_session_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == MaxSession) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1J Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1J_overallSAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "1J Overall SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1J_Par_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # By Par means
  group_by(TrialPar) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each par
  # Build table
  select(TrialPar, MeanSAP, sdSAP) %>% 
  arrange(TrialPar) %>% 
  kable(format = "html",
      caption = "1J By Trial SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 1J_correlation_Par_SAP, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # By Par means
  group_by(TrialPar) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each par
  # Build table
  select(TrialPar, MeanSAP) %>% 
  glm(TrialPar ~ MeanSAP, 
              data = .)
)
```
```{r 1J_correlation_Par_SAP_Estelle-Yoshi, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement"),
         Subject %in% c("Estelle", "Yoshi")
         ) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # By Par means
  group_by(TrialPar) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each par
  # Build table
  select(TrialPar, MeanSAP) %>% 
  glm(TrialPar ~ MeanSAP, 
              data = .)
)
```
```{r 1J.Test_RWM_SAP, echo=FALSE}
OneJ_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/4.b_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Par of 2
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = OneJ_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = OneJ_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "Exp1: Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 1TEST_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- c("4.b")
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/4.b_simulated_RWM_data.csv"

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% exp_phase,
         EventType %in% c("BananaReached"),
         Subject %in% c("Bowser", "Darwin", "Herriot", "Wario")
         ) %>%
  # Select first session of phase
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  filter(SessionNum == 1) %>% 
  ungroup() %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% 
  filter(SAP >= 0) %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path,
                     show_col_types = FALSE) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% exp_phase,
         EventType %in% c("BananaReached"),
         Subject %in% c("Bowser", "Darwin", "Herriot", "Wario")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == 1) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - phase_par) %>% 
  filter(SAP >= 0)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```


# Experiment 2 - Barrier Navigation Training
## Phase 2A & 2B
Single barrier with pacman left (2A) or right (2B)  

```{r 2A_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.a")) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2A Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2A_first_session_GLM_SAP, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase %in% c("5.a"),
         EventType %in% c("reinforcement"),
         # Subject %in% c("Herriot",
         #                "Wario",
         #                "Yoshi")
         ) %>%
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Grab only the first session
  filter(SessionNum %in% c(1)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - 1) %>% # Par was 1 for all 6a trials
  ungroup() %>% 
  group_by(Subject) %>% 
  select(Subject, TrialNum, TrialSap)

glm_model <- glm(TrialSap ~ TrialNum, 
              data = GLM_data)

summary(glm_model)
```
```{r 2A_first_session_GLM_TCT, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase %in% c("5.a"),
         EventType %in% c("reinforcement"),
         # Subject %in% c("Herriot",
         #                "Wario",
         #                "Yoshi")
         ) %>%
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Grab only the first session
  filter(SessionNum %in% c(1)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  select(Subject, TrialNum, TrialDuration)

glm_model <- glm(TrialDuration ~ TrialNum, 
              data = GLM_data)

summary(glm_model)
```
```{r 2A_first_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.a"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(max(TrialNum) >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  filter(SessionNum == 1) %>%  # Only grab first session
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>% # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
         GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2A First Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2A_terminal_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.a"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == MaxSession) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2A Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2A_SAP_first_vs_terminal_session_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.a"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Find SAP for each trial...
  group_by(Subject, WhichSession, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par of 1
  ungroup() %>% 
  # Subject Means
  group_by(Subject, WhichSession) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  #filter(row_number() == 1) %>% # Grab one data point for each subject
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build graphic
  ggplot(aes(x = WhichSession)) + 
  geom_line(aes(y = MeanSAP,
                group = Subject),
            color = "gray",
            alpha = 0.5
            )+
  geom_line(aes(y = GroupMeanSAP,
                group = 1)) +
  # Aesthetics
  theme_classic() +
  labs(title = "2.A SAP",
       y = "Mean SAP",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  ) +
  scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 2A_RWM_SAP, echo=FALSE}
twoA_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5.a_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("5.a"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = twoA_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = twoA_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "2.A Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2A_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- "5.a"
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5.a_simulated_RWM_data.csv"

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Select terminal session of phase
  # group_by(Subject) %>% 
  # mutate(SessionNum = dense_rank(Date),
  #        MaxSession = max(SessionNum)) %>%
  # filter(SessionNum == MaxSession) %>% 
  # ungroup() %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path,
                     show_col_types = FALSE) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == MaxSession) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - TrialPar)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```

```{r 2B_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.b")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2B Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2B_first_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == 1) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2B First Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2B_terminal_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == MaxSession) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2B Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2B_GLM_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
```{r 2B_RWM_SAP, echo=FALSE}
twoB_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5.b_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("5.b"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = twoB_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = twoB_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "2.B Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```

```{r 2AB_ttest_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5.a", "5.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
```{r 2AB_vs_1J, echo=FALSE}
two_AB_data <- combined_data %>%
  filter(TrainingPhase %in% c("5.a", "5.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

one_J_data <-combined_data %>%
  filter(TrainingPhase %in% c("4.b"),
         EventType %in% c("reinforcement")
         ) %>%
  filter(TrialPar <= 4) %>% # Only trials less than or equal to 4
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(two_AB_data$SAP,
             one_J_data$SAP,
             var.equal = TRUE))
```
```{r 2AB_GLM_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5.a","5.b"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
## Phase 2C & 2D
Double barrier with pacman left (2C) or right (2D)  

```{r 2C_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c")) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2C Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2C_first_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == 1) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2C First Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2C_terminal_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == MaxSession) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2C Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2C_GLM_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5.c"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
```{r 2D_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.d"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2D Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2D_first_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.d"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == 1) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2D First Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2D_terminal_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.d"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == MaxSession) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2D Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2D_GLM_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5.d"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
```{r 2D_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- "5.d"
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5.d_simulated_RWM_data.csv"

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Select terminal session of phase
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>%
  filter(SessionNum == MaxSession) %>% 
  ungroup() %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path,
                     show_col_types = FALSE) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == MaxSession) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - TrialPar)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```

```{r 2C2D_RWM_SAP, echo=FALSE}
twoC_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5.c_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM",
         TrainingPhase = as.character(TrainingPhase)) %>% 
  filter(SAP >= 0)

twoD_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5.d_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM",
         TrainingPhase = as.character(TrainingPhase)) %>% 
  filter(SAP >= 0)

twoC_twoD_RWM_data <- bind_rows(twoC_test_RWM_data, twoD_test_RWM_data)

combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = twoC_twoD_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = twoC_twoD_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2C2D_SAP_by_TrialPar, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  group_by(TrialPar) %>% 
  mutate(MeanSAPbyPar = mean(SAP,
                             na.rm = TRUE),
         sdSAPbyPar = sd(SAP)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = MeanSAPbyPar)) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0.7,
           fill = "darkseagreen4",
           color = "black") +
  geom_errorbar(aes(ymin = MeanSAPbyPar,
                    ymax = MeanSAPbyPar + sdSAPbyPar),
                position = position_dodge(width = 0.15),
                width = 0.2
                ) +
    # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D SAP Across Trial Types",
       y = "SAP",
       x = "Trial Par") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2C2D_count_high_SAP_by_TrialPar, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar, # Variable par
         HighSAP = ifelse(SAP > 30,
                          1,
                          0)
         ) %>% 
  ungroup() %>% 
  group_by(TrialPar) %>% 
  mutate(TotalHighSAP = mean(HighSAP)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = TotalHighSAP)) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0.7,
           fill = "darkseagreen4",
           color = "black") +
    # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D SAP Across Trial Types",
       y = "SAP",
       x = "Trial Par") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2C2D_SAP_by_TrialPar_nonFINAL_birds, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached")) %>% 
  mutate(PassingBird = ifelse(Subject %in% c("Wario", "Herriot", "Yoshi"),
                              "Pass",
                              "Non-Pass")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  group_by(TrialPar, PassingBird) %>% 
  mutate(MeanSAPbyPar = mean(SAP,
                             na.rm = TRUE),
         sdSAPbyPar = sd(SAP)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = MeanSAPbyPar,
             group = PassingBird)) +
  geom_bar(aes(fill = PassingBird),
           stat = "identity",
           position = "dodge",
           width = 0.7,
           color = "black") +
  geom_errorbar(aes(ymin = MeanSAPbyPar,
                    ymax = MeanSAPbyPar + sdSAPbyPar),
                position = position_dodge(width = 0.75),
                width = 0.2
                ) +
    # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D SAP Across Trial Types - Darwin & Bowser",
       y = "SAP",
       x = "Trial Par") +
  scale_fill_manual(values = c("seagreen4", "darkorange3")) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2C2D_SAP_by_TrialPar_violin_nonFINAL_birds, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached"),
         TrialPar == 6) %>% 
  mutate(PassingBird = ifelse(Subject %in% c("Wario", "Herriot", "Yoshi"),
                              "Pass",
                              "Non-Pass")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = PassingBird,
             y = SAP,
             color = PassingBird)) +
  geom_violin() +
  # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D SAP Across Trial Types",
       y = "SAP",
       x = "Trial Par") +
  scale_fill_manual(values = c("seagreen4", "darkorange3")) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2C2D_count_high_SAP_by_TrialPar_nonFINAL, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached"),
         !Subject %in% c("Wario", "Herriot", "Yoshi")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar, # Variable par
         HighSAP = ifelse(SAP > 25,
                          1,
                          0)
         ) %>% 
  ungroup() %>% 
  group_by(TrialPar) %>% 
  mutate(TotalHighSAP = mean(HighSAP)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = TotalHighSAP)) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0.7,
           fill = "darkseagreen4",
           color = "black") +
    # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D SAP Across Trial Types",
       y = "SAP",
       x = "Trial Par") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```

```{r 2CD_correlation_Par_SAP, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("reinforcement")
         ) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Build table
  select(TrialPar, SAP) %>% 
  glm(TrialPar ~ SAP, 
              data = .)
)
```
```{r 2CD_par6_vs_others, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  mutate(ParSixTrial = ifelse(TrialPar == 6,
                              TRUE,
                              FALSE)) %>% 
  # Subject/Session Means
  group_by(ParSixTrial) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>%  # Grab one data point for each subject for the table
  # Build table
  select(ParSixTrial, MeanSAP, sdSAP) %>% 
  kable(format = "html",
      caption = "2C & 2D Par 6 vs. Non-Par6 Trials SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2CD_par6_vs_others_ttest, echo=FALSE}
par_six_data <- combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("reinforcement"),
         TrialPar == 6
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

nonpar_six_data <- combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("reinforcement"),
         TrialPar != 6
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(par_six_data$SAP,
             nonpar_six_data$SAP,
             var.equal = TRUE))
```
```{r 2CD_SAP_by_TrialPar_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5.c", "5.d"),
         EventType %in% c("BananaReached"),
         #!Subject %in% c("Wario", "Herriot", "Yoshi")
         ) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  group_by(TrialPar) %>% 
  mutate(MeanSAPbyPar = mean(SAP,
                             na.rm = TRUE)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = MeanSAPbyPar)) +
  geom_point() +
  geom_smooth(method = "lm",
              se = TRUE,
              fill = "seagreen4",
              color = "black") +
    # Aesthetics
  theme_classic() +
  labs(title = "2.C & 2.D Mean SAP ~ Par GLM",
       y = "Mean SAP",
       x = "Trial Par") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```

## Phase 2 TEST
```{r 2TEST_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST")) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2 TEST Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2TEST_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>%  # Grab one data point for each subject for the table
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2 TEST SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2TEST_first_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == 1) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2 Test Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2TEST_terminal_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == MaxSession) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "2 TEST Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2TEST_GLM_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
```{r 2TEST_RWM_SAP, echo=FALSE}
two_test_RWM_data <- read_csv("/Users/cyruskirkman/Desktop/UCLA Research/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5_TEST_simulated_RWM_data.csv") %>% 
  filter(SessionNum %in% c(1:5)) %>% 
  filter(EventType %in% c("BananaReached")) %>%
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = max(MoveCounter) - TrialPar,
         GroupName = "RWM") %>% 
  filter(SAP >= 0)


combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  ggplot(aes(x = GroupName,
             y = SAP,
             group = GroupName)) +
  geom_violin() + 
  geom_violin(data = two_test_RWM_data) + 
  geom_jitter(size = 0.3,
              alpha = 0.3) + 
  geom_jitter(data = two_test_RWM_data,
              size = 0.3,
              alpha = 0.3) + 
    # Aesthetics
  theme_classic() +
  labs(title = "2 Test - Experimental SAP vs. RWM Control",
       y = "SAP",
       x = "Group") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2TEST_cont_vs_RWM_permutation_test, echo=FALSE}
# In order to test SAP differences between our pigeons and the RWM control,
# we first need to adjust the number of observations in the RWM dataset to 
# match the population of the pigeon data. Often times, we only want to compare
# the terminal training session of our subject data to the RWM (thus setting the 
# size of our experimental population). We can get that value below:
exp_phase <- "5 TEST"
RWM_csv_path <- "/Users/cyruskirkman/Desktop/P032a - Insight/Data Analysis/RWM_generated_data/P035_RWM_data_files/5_TEST_simulated_RWM_data.csv"

n_observations <- combined_data %>%
  # Specify phase and select one row per trial
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Select terminal session of phase
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>%
  filter(SessionNum == 1) %>% 
  ungroup() %>% 
  # Set count of remaining trials
  count() %>% 
  pull()

# Next we can import our RWM data and make edits
RWM_data <- read_csv(RWM_csv_path) %>% 
  # Only select one value per trial
  filter(EventType %in% c("BananaReached")) %>%
  # Calculate SAP
  group_by(Subject, SessionNum, TrialNum) %>% # For every trial
  mutate(SAP = MoveCounter - TrialPar,
         GroupName = "RWM",
         UniqueGroup = cur_group_id()
         ) %>% 
  # We only want to select n-number of trials for this population
  ungroup() %>% 
  filter(UniqueGroup <= n_observations) %>% 
  filter(SAP >= 0)

# Next, we want to create our experimental subject data population...
pigeon_data <- combined_data %>%
  filter(TrainingPhase %in% c(exp_phase),
         EventType %in% c("BananaReached")
         ) %>%
  # Assign a session number to select terminal training session
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         GroupName = "Pigeons") %>% 
  filter(SessionNum == 1) %>% 
  # Find SAP for each trial...
  mutate(SAP = MoveCounter - TrialPar)

# After we have our two data sets, we can proceed with the Wilcoxon rank-sum 
# below.

wilcox_result <- wilcox.test(pigeon_data$SAP, RWM_data$SAP)

cat(exp_phase, "results:\n")
print(wilcox_result)
cat("- Mean of pigeon data:", mean(pigeon_data$SAP), "\n")
cat("- Mean of RWA data:", mean(RWM_data$SAP))

```

There was also a positive correlation between trial par and SAP  
```{r 2TEST_by_Par_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  # TrialPar Info/Means
  group_by(TrialPar) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1) %>%  # Grab one data point for each subject for the table
  ungroup() %>% 
  # Build table
  select(TrialPar, MeanSAP, sdSAP) %>% 
  arrange(TrialPar) %>% 
  kable(format = "html",
      caption = "2 TEST By Par SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 2TEST_GLM_SAP_by_TrialPar, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  glm(SAP ~ TrialPar, 
              data = .)
)
```
```{r 2TEST_SAP_by_TrialPar, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  group_by(TrialPar) %>% 
  mutate(MeanSAPbyPar = mean(SAP,
                             na.rm = TRUE),
         sdSAPbyPar = sd(SAP)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = MeanSAPbyPar)) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0.7,
           fill = "darkseagreen4",
           color = "black") +
  geom_errorbar(aes(ymin = MeanSAPbyPar,
                    ymax = MeanSAPbyPar + sdSAPbyPar),
                position = position_dodge(width = 0.15),
                width = 0.2
                ) +
    # Aesthetics
  theme_classic() +
  labs(title = "2 TEST SAP Across Trial Types",
       y = "SAP",
       x = "Trial Par") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```
```{r 2TEST_SAP_by_TrialPar_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("BananaReached")) %>% 
  group_by(Subject, Date) %>% 
  filter(max(TrialNum) > 5) %>%  # Take out sessions with fewer than 5 trials
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum),
         GroupName = "Pigeons") %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  filter(SAP >= 0) %>% 
  ungroup() %>% 
  group_by(TrialPar) %>% 
  mutate(MeanSAPbyPar = mean(SAP,
                             na.rm = TRUE)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = TrialPar,
             y = MeanSAPbyPar)) +
  geom_smooth(method = "lm",
              se = TRUE,
              fill = "seagreen4",
              color = "black") +
    # Aesthetics
  theme_classic() +
  labs(title = "Exp2: SAP ~ Par GLM",
       y = "SAP",
       x = "Trial Par") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
  
```


# Experiment 3 - Portal Training
Only one phase type in which portals were  

```{r 3_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("6")) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         NumSessions = max(SessionNum)
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, NumSessions) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "3 Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### First session info
```{r 3_first_session_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par was always 1
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == 1) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "3 First Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 3_terminal_trial_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par was always 1
  ungroup() %>% 
  # Subject/Session Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  filter(row_number() == 1, # Grab one data point for each subject for the table
         SessionNum == MaxSession) %>%  # Grab first session data only
  ungroup() %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build table
  select(Subject, SessionNum, MeanSAP, sdSAP, GroupMeanSAP, GroupsdSAP) %>% 
  arrange(Subject) %>% 
  kable(format = "html",
      caption = "3 Terminal Session SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 3_SAP_first_vs_terminal_session_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Select only first and terminal sessions
  filter(SessionNum %in% c(1, MaxSession)) %>% 
  mutate(WhichSession = ifelse(SessionNum == 1,
                                "First",
                                "Terminal")
         ) %>% 
  # Find SAP for each trial...
  group_by(Subject, WhichSession, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par of 1
  ungroup() %>% 
  # Subject Means
  group_by(Subject, WhichSession) %>% 
  mutate(MeanSAP = mean(SAP),
         sdSAP = sd(SAP)) %>% 
  #filter(row_number() == 1) %>% # Grab one data point for each subject
  ungroup() %>% 
  group_by(WhichSession) %>% 
  mutate(GroupMeanSAP = mean(MeanSAP),
       GroupsdSAP = sd(MeanSAP)) %>% 
  # Build graphic
  ggplot(aes(x = WhichSession)) + 
  geom_line(aes(y = MeanSAP,
                group = Subject),
            color = "gray",
            alpha = 0.5
            )+
  geom_line(aes(y = GroupMeanSAP,
                group = 1)) +
  ylim(0, 12) +
  # Aesthetics
  theme_classic() +
  labs(title = "3 Test SAP",
       y = "Mean SAP",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  ) +
  scale_x_discrete(expand = c(0.1, 0.1))
```
```{r 3_GLM_SAP_by_session, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par of 1
  ungroup() %>% 
  glm(SAP ~ SessionNum, 
              data = .)
)
```
```{r 3_SAP_by_session_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  filter(SessionNum != 9) %>% 
  mutate(MaxSession = max(SessionNum)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1) %>% # Par of 1
  ungroup() %>% 
  # Subject Means
  group_by(Subject, SessionNum) %>% 
  mutate(MeanSAP = mean(SAP,
                        na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(SessionNum) %>% 
  mutate(MeanofMeanSAP = mean(MeanSAP)) %>% 
  ungroup() %>% 
  # Build graphic
  ggplot(aes(x = SessionNum)) + 
  geom_line(aes(y = MeanSAP,
                group = Subject),
            color = "gray",
            alpha = 0.5
            ) +
  geom_line(aes(y = MeanofMeanSAP)) +
  # Aesthetics
  theme_classic() +
  labs(title = "3 Test SAP Over Time",
       y = "Mean SAP",
       x = "Session") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15))
  )
```
```{r 3_perfect_portal_use_graphic, echo=FALSE}
combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         Holder = 1) %>% 
  filter(SessionNum != 9) %>% 
  mutate(MaxSession = max(SessionNum)) %>% 
  filter(SessionNum %in% c(MaxSession,
                           MaxSession - 1,
                           MaxSession - 2)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - 1,
         PerfectTrial = ifelse(SAP == 0,
                               1,
                               0)) %>% 
  ungroup() %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(MeanPerfectTrial = mean(PerfectTrial,
                                 na.rm = TRUE),
         MeanSAP = mean(SAP,
                        na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(SessionNum) %>% 
  mutate(MeanofMeanSAP = mean(MeanSAP)) %>% 
  ungroup() %>% 
  # Build graphic
  ggplot(aes(x = Holder)) + 
  geom_boxplot(aes(y = MeanPerfectTrial)) +
  geom_hline(yintercept = 0.3033,
             linetype = "dashed") + 
  #coord_flip() +  # Flip x and y axes
  ylim(0,1) +
  # Aesthetics
  theme_classic() +
  labs(title = "Portal Differentiation",
       y = "First-Choice Accuracy",
       x = "Terminal Three Sessions") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    axis.title.x = element_blank(),  # Remove y-axis title
    axis.text.x = element_blank(),  # Remove y-axis labels
    axis.ticks.x = element_blank()  # Remove y-axis ticks
  )
  
```

```{r 3_perfect_portal_beta_regression, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase %in% c("6"),
         EventType %in% c("reinforcement")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(PerfectTrial = ifelse(max(MoveCounter) > 1,
                               0,
                               1)) %>% 
  ungroup() %>% 
  group_by(Subject, SessionNum) %>% 
  mutate(MeanPerfectTrial = mean(PerfectTrial,
                                 na.rm = TRUE)) %>% 
  # One row per session per bird
  filter(row_number() == 1) %>%
  # Adjust extreme values of 0 & 1 to avoid infinite log-likelihood values
  mutate(MeanPerfectTrial = ifelse(MeanPerfectTrial == 0, 0.0001, 
                                  ifelse(MeanPerfectTrial == 1, 0.9999, MeanPerfectTrial))) %>% 
  ungroup() %>% 
  select(Subject, SessionNum, MeanPerfectTrial) %>% 
  betareg(MeanPerfectTrial ~ SessionNum, 
          data = .)
)
```

# Experiment 4 - Insight Experiment
## Phase 4A
### Phase 4A Information
```{r 4A_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, InsightTrialType, NTrials, MeanSAP) %>% 
  kable(format = "html",
      caption = "4A Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### 4A first trial information
```{r 4A_first_trial_data, echo=FALSE}
Exp4_4A_T1_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         TrialNum == 1,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(FirstTrialCompletion = as.numeric(max(TrialTime)),
         FirstTrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         meanIRI = mean(IRI, 
                        na.rm = TRUE)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofFirstTrialCompletion = mean(FirstTrialCompletion),
         MeanofFirstTrialSap = mean(FirstTrialSap),
         ) %>% 
  select(Subject, TrainingPhase, InsightTrialType, TrialNum, FirstTrialCompletion,
         MeanofFirstTrialCompletion, FirstTrialSap, MeanofFirstTrialSap, meanIRI)

# 4A First Trial Completion Times
Exp4_4A_T1_data %>% 
    select(Subject, InsightTrialType,  FirstTrialCompletion,
           MeanofFirstTrialCompletion, meanIRI) %>% 
  kable(format = "html",
        caption = "4A First Trial Completion Times (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4A First Trial SAP
Exp4_4A_T1_data %>% 
  select(Subject,InsightTrialType, FirstTrialSap, MeanofFirstTrialSap) %>% 
  kable(format = "html",
        caption = "4A First Trial SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### Rest of 4A session information
```{r 4A_rest_of_session_data, echo=FALSE}
Exp4_4A_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi"),
         TrialNum != 1
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE),
         ) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSap),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  group_by(Subject) %>% 
  filter(row_number() == 1)
  
# 4A Session-Wide Trial Duration
Exp4_4A_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanTrialDuration, MoMTrialDuration, sdTD) %>%
  kable(format = "html",
        caption = "4A Session-Wide Trial Duration (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4A Session-Wide IRI
Exp4_4A_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4A Session-Wide IRIs (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# "4A Session-Wide SAP"
Exp4_4A_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanSAP, MoMSAP, sdSAP) %>% 
  kable(format = "html",
        caption = "4A Session-Wide SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### 4A GLMs
#### 4A GLM for SAP
```{r 4A_GLM_SAP, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialSap)

glm_model <- glm(TrialSap ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4A_ind_GLM_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4A: w/in Subject SAP GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4A GLM for Trial Completion Time
```{r 4A_GLM_TCT, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialDuration)

glm_model <- glm(TrialDuration ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4A_ind_GLM_TCT, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialDuration, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    TCT_GLM_Slope = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    TCT_GLM_SE = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    TCT_GLM_Tval = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    TCT_GLM_Sig = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, TCT_GLM_Slope, TCT_GLM_SE,
         TCT_GLM_Tval, TCT_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4A: w/in Subject TCT GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4A GLM for Inter-Response Intervals
```{r 4A_GLM_IRI_cross_session, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, MeanTrialIRI)

glm_model <- glm(MeanTrialIRI ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4A_GLM_IRI_within_trial_table, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         TrialNum == 1,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(IRI = ifelse(row_number() == 1,
                      TrialTime,
                      TrialTime - lag(TrialTime)),
         ResponseCounter = dense_rank(TrialTime)) %>% 
  # Take one row from each trial
  select(Subject, InsightTrialType, EventType, TrialTime, IRI, ResponseCounter) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    IRI_GLM_Slope = coef(summary(glm(IRI ~ ResponseCounter,
                                     data = cur_data())))[2],
    # Next the significance for each subject
    IRI_GLM_Sig = coef(summary(glm(IRI ~ ResponseCounter,
                                   data = cur_data())))[8]) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, InsightTrialType, IRI_GLM_Slope, IRI_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4A: w/in First Trial IRI GLM Data") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4A_ind_GLM_IRI, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.1",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, MeanTrialIRI, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    IRI_GLM_Slope = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    IRI_GLM_SE = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    IRI_GLM_Tval = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    IRI_GLM_Sig = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, IRI_GLM_Slope, IRI_GLM_SE,
         IRI_GLM_Tval, IRI_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4A: w/in Subject IRI GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### 4A compared to 2 TEST SAP performance
```{r 4A_vs_2TTest, echo=FALSE}
fiveTEST_data <- combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement"),
         TrialPar == 4
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Then select the terminal three sessions
  filter(SessionNum %in% c(MaxSession)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

fourA_data <-combined_data %>%
  filter(TrainingPhase %in% c("7 TEST"),
         InsightTrialType == "7.1",
         EventType %in% c("reinforcement")) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(fiveTEST_data$SAP,
             fourA_data$SAP,
             var.equal = FALSE))
```
```{r 4A_vs_2TOST, echo=FALSE}
exp4_phase <- "7.3"
trial_par <- 6

fiveTEST_data <- combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement"),
         TrialPar == trial_par
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Then select the terminal sessions
  filter(SessionNum %in% c(MaxSession)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

fourA_data <-combined_data %>%
  filter(TrainingPhase %in% c("7 TEST"),
         InsightTrialType == exp4_phase,
         EventType %in% c("reinforcement")) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Combine the two datasets
all_data <- bind_rows(fiveTEST_data, fourA_data)

# Calculate pooled standard deviation
pooled_sd <- sd(all_data$SAP, na.rm = TRUE)

# Define Cohen's d (e.g., medium effect size)
cohen_d <- 0.8

# Calculate equivalence margin
equivalence_margin <- cohen_d * pooled_sd

# Conduct the Two One-Sided Tests (TOST)
tost_result <- tost(fiveTEST_data$SAP[1:length(fourA_data$SAP)],
                    fourA_data$SAP,
                    low_eqbound = -equivalence_margin,
                    upp_eqbound = equivalence_margin,
                    var.equal = FALSE)

bf_result <- ttestBF(fiveTEST_data$SAP[1:length(fourA_data$SAP)],
                     fourA_data$SAP,
                     # rscale = "medium",
                     # nullInterval = c(-equivalence_margin, equivalence_margin),
                     paired = FALSE)
                     

# Print the results
print(tost_result)
```

## Phase 4B
### Phase 4B Information
```{r 4B_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, InsightTrialType, NTrials, MeanSAP) %>% 
  kable(format = "html",
      caption = "4B Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### 4B first trial information
```{r 4B_first_trial_data, echo=FALSE}
Exp4_4B_T1_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         TrialNum == 2,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(FirstTrialCompletion = as.numeric(max(TrialTime)),
         FirstTrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         meanIRI = mean(IRI, 
                        na.rm = TRUE)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofFirstTrialCompletion = mean(FirstTrialCompletion),
         MeanofFirstTrialSap = mean(FirstTrialSap),
         ) %>% 
  select(Subject, TrainingPhase, InsightTrialType, TrialNum, FirstTrialCompletion,
         MeanofFirstTrialCompletion, FirstTrialSap, MeanofFirstTrialSap, meanIRI)

# 4B First Trial Completion Times
Exp4_4B_T1_data %>% 
    select(Subject, InsightTrialType,  FirstTrialCompletion,
           MeanofFirstTrialCompletion, meanIRI) %>% 
  kable(format = "html",
        caption = "4B First Trial Completion Times (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")

# 4B First Trial SAP
Exp4_4B_T1_data %>% 
  select(Subject,InsightTrialType, FirstTrialSap, MeanofFirstTrialSap) %>% 
  kable(format = "html",
        caption = "4B First Trial SAP")%>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### Rest of 4B session information
```{r 4B_rest_of_session_data, echo=FALSE}
Exp4_4B_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi"),
         TrialNum != 1
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE),
         ) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSap),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  group_by(Subject) %>% 
  filter(row_number() == 1)
  
# 4B Session-Wide Trial Duration
Exp4_4B_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanTrialDuration, MoMTrialDuration, sdTD) %>%
  kable(format = "html",
        caption = "4B Session-Wide Trial Duration (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4B Session-Wide IRI
Exp4_4B_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4B Session-Wide IRIs (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# "4B Session-Wide SAP"
Exp4_4B_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanSAP, MoMSAP, sdSAP) %>% 
  kable(format = "html",
        caption = "4B Session-Wide SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### 4B GLMs
#### 4B GLM for SAP
```{r 4B_GLM_SAP, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialSap)

glm_model <- glm(TrialSap ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4B_ind_GLM_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4B: w/in Subject SAP GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4B GLM for Trial Completion Time
```{r 4B_GLM_TCT, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialDuration)

glm_model <- glm(TrialDuration ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4B_ind_GLM_TCT, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialDuration, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    TCT_GLM_Slope = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    TCT_GLM_SE = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    TCT_GLM_Tval = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    TCT_GLM_Sig = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, TCT_GLM_Slope, TCT_GLM_SE,
         TCT_GLM_Tval, TCT_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4B: w/in Subject TCT GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4B GLM for Inter-Response Intervals
```{r 4B_GLM_IRI, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, MeanTrialIRI)

glm_model <- glm(MeanTrialIRI ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4B_ind_GLM_IRI, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.2",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, MeanTrialIRI, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    IRI_GLM_Slope = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    IRI_GLM_SE = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    IRI_GLM_Tval = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    IRI_GLM_Sig = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, IRI_GLM_Slope, IRI_GLM_SE,
         IRI_GLM_Tval, IRI_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4B: w/in Subject IRI GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```


### 4B compared to 2 TEST SAP performance
```{r 4B_vs_2Test, echo=FALSE}
fiveTEST_data <- combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement"),
         TrialPar == 4
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Then select the terminal three sessions
  filter(SessionNum %in% c(MaxSession)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

fourA_data <-combined_data %>%
  filter(TrainingPhase %in% c("7 TEST"),
         InsightTrialType == "7.2",
         EventType %in% c("reinforcement")) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(fiveTEST_data$SAP,
             fourA_data$SAP,
             var.equal = FALSE))
```
```{r 4B_vs_2Test_graphic, echo=FALSE}
combined_data %>%
  mutate(InsightTrialType = ifelse(TrainingPhase == "5 TEST",
                                   "2 Test",
                                   InsightTrialType)) %>% 
  filter(InsightTrialType %in% c("2 Test", "7.2"),
         EventType %in% c("reinforcement"),
         TrialPar == 4
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup() %>% 
  group_by(Subject, InsightTrialType) %>% 
  mutate(meanSAP = mean(SAP,
                        na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(InsightTrialType) %>% 
  mutate(MoMSAP = mean(meanSAP),
         sdSAP = sd(meanSAP)) %>% 
  ungroup() %>% 
   # Build graphic
  ggplot(aes(y = MoMSAP,
             x = InsightTrialType,
             fill = InsightTrialType)) + 
  geom_bar(stat = "identity",
         position = "dodge",
         width = 0.7,
         color = "black") +
  geom_errorbar(aes(ymin = MoMSAP,
                    ymax = MoMSAP + sdSAP * 1.96),
                position = position_dodge(width = 0.15),
                width = 0.2
                ) +
      # Aesthetics
  theme_classic() +
  labs(title = "Efficiency Across 2 Test Par4 & 4.b Trials",
       y = "Mean SAP",
       x = "",
       fill = "Phase") +
  scale_fill_manual(values = c("darkorange3", "seagreen4")) +
  scale_y_continuous(breaks = integer_breaks()) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()
  )
  
```

## Phase 4C
### Phase 4C Information
```{r 4C_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, InsightTrialType, NTrials, MeanSAP) %>% 
  kable(format = "html",
      caption = "4C Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### 4C first trial information
```{r 4C_first_trial_data, echo=FALSE}
Exp4_4C_T1_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         TrialNum == 3,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(FirstTrialCompletion = as.numeric(max(TrialTime)),
         FirstTrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         meanIRI = mean(IRI, 
                        na.rm = TRUE)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofFirstTrialCompletion = mean(FirstTrialCompletion),
         MeanofFirstTrialSap = mean(FirstTrialSap),
         ) %>% 
  select(Subject, TrainingPhase, InsightTrialType, TrialNum, FirstTrialCompletion,
         MeanofFirstTrialCompletion, FirstTrialSap, MeanofFirstTrialSap, meanIRI)

# 4B First Trial Completion Times
Exp4_4C_T1_data %>% 
    select(Subject, InsightTrialType,  FirstTrialCompletion,
           MeanofFirstTrialCompletion, meanIRI) %>% 
  kable(format = "html",
        caption = "4C First Trial Completion Times (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4B First Trial SAP
Exp4_4C_T1_data %>% 
  select(Subject,InsightTrialType, FirstTrialSap, MeanofFirstTrialSap) %>% 
  kable(format = "html",
        caption = "4C First Trial SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### Rest of 4C session information
```{r 4C_rest_of_session_data, echo=FALSE}
Exp4_4C_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi"),
         TrialNum != 1
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE),
         ) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSap),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  group_by(Subject) %>% 
  filter(row_number() == 1)
  
# 4C Session-Wide Trial Duration
Exp4_4C_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanTrialDuration, MoMTrialDuration, sdTD) %>%
  kable(format = "html",
        caption = "4C Session-Wide Trial Duration (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4C Session-Wide IRI
Exp4_4C_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4C Session-Wide IRIs (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# "4C Session-Wide SAP"
Exp4_4C_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanSAP, MoMSAP, sdSAP) %>% 
  kable(format = "html",
        caption = "4C Session-Wide SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### 4C GLMs
#### 4C GLM for SAP
```{r 4C_GLM_SAP, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialSap)

glm_model <- glm(TrialSap ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4C_ind_GLM_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4C: w/in Subject SAP GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4C_ind_GLM_SAP_trials_removed, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Remove trials with SAP of greater than target
  filter(TrialSap < 8) %>% 
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ TrialNum,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ TrialNum,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ TrialNum,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ TrialNum,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(TrialNum)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4C: w/in Subject SAP GLM (trials w/ SAP > 8 removed)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4C GLM for Trial Completion Time
```{r 4C_GLM_TCT, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialDuration)

glm_model <- glm(TrialDuration ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4C_ind_GLM_TCT, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialDuration, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    TCT_GLM_Slope = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    TCT_GLM_SE = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    TCT_GLM_Tval = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    TCT_GLM_Sig = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, TCT_GLM_Slope, TCT_GLM_SE,
         TCT_GLM_Tval, TCT_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4C: w/in Subject TCT GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4C GLM for Inter-Response Intervals
```{r 4C_GLM_IRI, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, MeanTrialIRI)

glm_model <- glm(MeanTrialIRI ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4C_ind_GLM_IRI, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.3",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, MeanTrialIRI, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    IRI_GLM_Slope = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    IRI_GLM_SE = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    IRI_GLM_Tval = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    IRI_GLM_Sig = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, IRI_GLM_Slope, IRI_GLM_SE,
         IRI_GLM_Tval, IRI_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4C: w/in Subject IRI GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### 4C compared to 2 TEST SAP performance
```{r 4C_vs_2Test, echo=FALSE}
fiveTEST_data <- combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement"),
         TrialPar == 6
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Then select the terminal three sessions
  filter(SessionNum %in% c(MaxSession)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

fourC_data <-combined_data %>%
  filter(TrainingPhase %in% c("7 TEST"),
         InsightTrialType == "7.3",
         EventType %in% c("reinforcement")) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(fiveTEST_data$SAP,
             fourC_data$SAP,
             var.equal = FALSE))
```



## Phase 4D
### Phase 4D Information
```{r 4D_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, InsightTrialType, NTrials, MeanSAP) %>% 
  kable(format = "html",
      caption = "4D Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### 4D first trial information
```{r 4D_first_trial_data, echo=FALSE}
Exp4_4D_T1_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         TrialNum == 4,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(FirstTrialCompletion = as.numeric(max(TrialTime)),
         FirstTrialSap = max(MoveCounter) - TrialPar - 1, # Phase 4 trial SAP was off by 1
         IRI = TrialTime - lag(TrialTime),
         meanIRI = mean(IRI, 
                        na.rm = TRUE)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofFirstTrialCompletion = mean(FirstTrialCompletion),
         MeanofFirstTrialSap = mean(FirstTrialSap),
         ) %>% 
  select(Subject, TrainingPhase, InsightTrialType, TrialNum, FirstTrialCompletion,
         MeanofFirstTrialCompletion, FirstTrialSap, MeanofFirstTrialSap, meanIRI)

# 4B First Trial Completion Times
Exp4_4D_T1_data %>% 
    select(Subject, InsightTrialType,  FirstTrialCompletion,
           MeanofFirstTrialCompletion, meanIRI) %>% 
  kable(format = "html",
        caption = "4D First Trial Completion Times (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4B First Trial SAP
Exp4_4D_T1_data %>% 
  select(Subject,InsightTrialType, FirstTrialSap, MeanofFirstTrialSap) %>% 
  kable(format = "html",
        caption = "4D First Trial SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### 4D second trial information
```{r 4D_second_trial_data, echo=FALSE}
Exp4_4D_T2_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         TrialNum == 9,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SecondTrialCompletion = as.numeric(max(TrialTime)),
         SecondTrialSap = max(MoveCounter) - TrialPar - 1, # Phase 4 trial SAP was off by 1
         IRI = TrialTime - lag(TrialTime),
         meanIRI = mean(IRI, 
                        na.rm = TRUE)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofSecondTrialCompletion = mean(SecondTrialCompletion),
         MeanofSecondTrialSap = mean(SecondTrialSap),
         ) %>% 
  select(Subject, TrainingPhase, InsightTrialType, TrialNum, SecondTrialCompletion,
         MeanofSecondTrialCompletion, SecondTrialSap, MeanofSecondTrialSap, meanIRI)

# 4B Second Trial Completion Times
Exp4_4D_T2_data %>% 
    select(Subject, InsightTrialType,  SecondTrialCompletion,
           MeanofSecondTrialCompletion, meanIRI) %>% 
  kable(format = "html",
        caption = "4D Second Trial Completion Times (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4B Second Trial SAP
Exp4_4D_T2_data %>% 
  select(Subject,InsightTrialType, SecondTrialSap, MeanofSecondTrialSap) %>% 
  kable(format = "html",
        caption = "4D Second Trial SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```


### Rest of 4D session information
```{r 4D_rest_of_session_data, echo=FALSE}
Exp4_4D_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi"),
         TrialNum != 4
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSap = max(MoveCounter) - TrialPar - 1, # Phase 4 trial SAP was off by 1
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE),
         ) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSap),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  group_by(Subject) %>% 
  filter(row_number() == 1)
  
# 4C Session-Wide Trial Duration
Exp4_4D_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanTrialDuration, MoMTrialDuration, sdTD) %>%
  kable(format = "html",
        caption = "4D Session-Wide Trial Duration (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4C Session-Wide IRI
Exp4_4D_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4D Session-Wide IRIs (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# "4C Session-Wide SAP"
Exp4_4D_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanSAP, MoMSAP, sdSAP) %>% 
  kable(format = "html",
        caption = "4D Session-Wide SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4D_vs_2Test, echo=FALSE}
fiveTEST_data <- combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement"),
         TrialPar == 4
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Then select the terminal three sessions
  filter(SessionNum %in% c(MaxSession)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

fourD_data <-combined_data %>%
  filter(TrainingPhase %in% c("7 TEST"),
         InsightTrialType == "7.4",
         EventType %in% c("reinforcement")) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar - 1) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(fiveTEST_data$SAP,
             fourD_data$SAP,
             var.equal = FALSE))
```

### 4D Portal Entrance Ratios
```{r 4D_portal_entrance_ratios, echo=FALSE}
# Percentage of sessions with portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(PortalAccessRate = mean(DidEnterPortal)) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(AvgPortalAccessRate = mean(PortalAccessRate)) %>%
  select(Subject, InsightTrialType, PortalAccessRate, AvgPortalAccessRate) %>% 
  kable(format = "html",
        caption = "4D Percentage of Trials w/ Portal Use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4D_portal_usage_info, echo=FALSE}
# Info for trials w/ portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 1) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSAP = max(MoveCounter) - TrialPar - 1, # Phase 4 trial SAP was off by 1
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE)
         ) %>% 
  # We now only need one row per trial per bird...
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSAP,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  # Now we only need one row per subject
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSAP),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  # Make table
  select(Subject, InsightTrialType, NTrials, MeanSAP,MoMSAP,sdSAP,
         MeanTrialDuration, MoMTrialDuration,sdTD, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4D - Performance in Trials w/ Portal Use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4D_nonportal_usage_info, echo=FALSE}
# Info for trials w/ portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 0) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSAP = max(MoveCounter) - TrialPar - 1, # Phase 4 trial SAP was off by 1
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE)
         ) %>% 
  # We now only need one row per trial per bird...
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSAP,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  # Now we only need one row per subject
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSAP),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  # Make table
  select(Subject, InsightTrialType, NTrials, MeanSAP,MoMSAP,sdSAP,
         MeanTrialDuration, MoMTrialDuration,sdTD, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4D - Performance in Trials w/o Portal Use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4D_portal_entrance_ratios_graphic, echo=FALSE}
# Percentage of sessions with portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal),
         TextDidEnterPortal = ifelse(DidEnterPortal == 1,
                                     "Y",
                                     "N")
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(MeanDidNotEnterPortal = 1 - mean(DidEnterPortal,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  #build graphic
  ggplot(aes(x = Subject,
             y = MeanDidNotEnterPortal)) + 
    geom_bar(aes(y = 1),
             stat = "identity",
         position = "dodge",
         width = 0.7,
         color = "black",
         fill = "darkorange3") +
  geom_bar(stat = "identity",
         position = "dodge",
         width = 0.7,
         color = "black",
         fill = "seagreen4") +
  geom_hline(yintercept = 0.5,
             linetype = "dashed") +
  ylim(0, 1) +
      # Aesthetics
  theme_classic() +
  labs(title = "Exp 4.d - Portal Discrimination",
       y = "Ratio Trials w/o Portal Use") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15))
  )
  
  
```

```{r 4D_portal_SAP_comp_ratios_graphic, echo=FALSE}
# Percentage of sessions with portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal),
         TextDidEnterPortal = ifelse(DidEnterPortal == 1,
                                     "Y",
                                     "N"),
         SAP = max(MoveCounter) - TrialPar
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  #build graphic
  ggplot(aes(x = TextDidEnterPortal,
             y = SAP, 
             fill = TextDidEnterPortal)) + 
  geom_boxplot() +
      # Aesthetics
  theme_classic() +
  labs(title = "Exp 4.d - SAP Across Trials",
       y = "SAP",
       fill = "Portal Used") +
  scale_fill_manual(values = c("seagreen4", "darkorange3")) +
  scale_y_continuous(breaks = integer_breaks()) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()
  )
  
  
```
### 4D GLMs
#### 4D GLM for SAP
```{r 4D_GLM_SAP, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialSap) %>% 
  glm(TrialSap ~ KeyTrialCounter, 
              data = .)
)
```
```{r 4D_mean_GLM_SAP_nonportal_usage_info, echo=FALSE}
# Info for trials w/ portal entry
summary(
  combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 0) %>% 
  # FInd SAP
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialSap) %>% 
  glm(TrialSap ~ KeyTrialCounter, 
              data = .)
)
```
```{r 4D_ind_GLM_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4D: w/in Subject SAP GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4D_ind_GLM_SAP_nonportal_usage_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 0) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ TrialNum,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ TrialNum,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ TrialNum,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ TrialNum,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(TrialNum)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4D: w/in Subject SAP GLM w/o trial use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4D GLM for Trial Completion Time
```{r 4D_GLM_TCT, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialDuration) %>% 
  glm(TrialDuration ~ KeyTrialCounter, 
      data = .)
)
```
```{r 4D_ind_GLM_TCT, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialDuration, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    TCT_GLM_Slope = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    TCT_GLM_SE = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    TCT_GLM_Tval = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    TCT_GLM_Sig = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, TCT_GLM_Slope, TCT_GLM_SE,
         TCT_GLM_Tval, TCT_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4D: w/in Subject TCT GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4D GLM for Inter-Response Intervals
```{r 4D_GLM_IRI, echo=FALSE}
summary(
  combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, MeanTrialIRI) %>% 
  glm(MeanTrialIRI ~ KeyTrialCounter, 
      data = .)
)
```
```{r 4D_ind_GLM_IRI, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.4",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, MeanTrialIRI, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    IRI_GLM_Slope = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    IRI_GLM_SE = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    IRI_GLM_Tval = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    IRI_GLM_Sig = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, IRI_GLM_Slope, IRI_GLM_SE,
         IRI_GLM_Tval, IRI_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4D: w/in Subject IRI GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```




## Phase 4E
### Phase 4E Information
```{r 4E_info, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  filter(row_number() == 1) %>% 
  select(Subject, InsightTrialType, NTrials, MeanSAP) %>% 
  kable(format = "html",
      caption = "4E Info") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### 4E first trial information
```{r 4E_first_trial_data, echo=FALSE}
Exp4_4E_T1_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         TrialNum == 5,
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(FirstTrialCompletion = as.numeric(max(TrialTime)),
         FirstTrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         meanIRI = mean(IRI, 
                        na.rm = TRUE)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MeanofFirstTrialCompletion = mean(FirstTrialCompletion),
         MeanofFirstTrialSap = mean(FirstTrialSap),
         ) %>% 
  select(Subject, TrainingPhase, InsightTrialType, TrialNum, FirstTrialCompletion,
         MeanofFirstTrialCompletion, FirstTrialSap, MeanofFirstTrialSap, meanIRI)

# 4E First Trial Completion Times
Exp4_4E_T1_data %>% 
    select(Subject, InsightTrialType,  FirstTrialCompletion,
           MeanofFirstTrialCompletion, meanIRI) %>% 
  kable(format = "html",
        caption = "4E First Trial Completion Times (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4E First Trial SAP
Exp4_4E_T1_data %>% 
  select(Subject,InsightTrialType, FirstTrialSap, MeanofFirstTrialSap) %>% 
  kable(format = "html",
        caption = "4E First Trial SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

### Rest of 4E session information
```{r 4E_rest_of_session_data, echo=FALSE}
Exp4_4E_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi"),
         TrialNum != 5
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSap = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE),
         ) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSap,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSap),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  group_by(Subject) %>% 
  filter(row_number() == 1)
  
# 4E Session-Wide Trial Duration
Exp4_4E_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanTrialDuration, MoMTrialDuration, sdTD) %>%
  kable(format = "html",
        caption = "4E Session-Wide Trial Duration (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# 4C Session-Wide IRI
Exp4_4E_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4E Session-Wide IRIs (in seconds)") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
# "4C Session-Wide SAP"
Exp4_4E_data %>% 
    select(Subject, InsightTrialType, NTrials, MeanSAP, MoMSAP, sdSAP) %>% 
  kable(format = "html",
        caption = "4E Session-Wide SAP") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
### Portal-Dependent info
```{r 4E_portal_entrance_ratios, echo=FALSE}
# Percentage of sessions with portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal)
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(PortalAccessRate = mean(DidEnterPortal)) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(AvgPortalAccessRate = mean(PortalAccessRate)) %>%
  select(Subject, InsightTrialType, PortalAccessRate, AvgPortalAccessRate) %>% 
  kable(format = "html",
        caption = "4E Percentage of Trials w/ Portal Use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4E_portal_entrance_ratios_graphic1, echo=FALSE}
# Percentage of sessions with portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal),
         TextDidEnterPortal = ifelse(DidEnterPortal == 1,
                                     "Portal",
                                     "Direct")
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ggplot(aes(x = DidEnterPortal,
             fill = TextDidEnterPortal)) + 
  geom_bar(color = "black") + 
  facet_wrap(vars(Subject)) +
      # Aesthetics
  theme_classic() +
  labs(title = "Exp 4.e - Trials With Portal Use",
       y = "Trials",
       x = "Trial Par",
       fill = "Tactic") +
  scale_fill_manual(values = c("darkorange3", "seagreen4")) +
  scale_y_continuous(breaks = integer_breaks()) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()
  )
  
  
```
```{r 4E_portal_usage_info, echo=FALSE}
# Info for trials w/ portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 1) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSAP = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE)
         ) %>% 
  # We now only need one row per trial per bird...
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSAP,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  # Now we only need one row per subject
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSAP),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  # Make table
  select(Subject, InsightTrialType, NTrials, MeanSAP,MoMSAP,sdSAP,
         MeanTrialDuration, MoMTrialDuration,sdTD, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4E - Performance in Trials w/ Portal Use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4E_nonportal_usage_info, echo=FALSE}
# Info for trials w/ portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 0) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime)),
         TrialSAP = max(MoveCounter) - TrialPar,
         IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = mean(IRI,
                        na.rm = TRUE)
         ) %>% 
  # We now only need one row per trial per bird...
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  # By subject means...
  group_by(Subject) %>% 
  mutate(MeanTrialDuration = mean(TrialDuration,
                                  na.rm = TRUE),
         MeanSAP = mean(TrialSAP,
                       na.rm = TRUE),
         MeanIRI = mean(MeanTrialIRI,
                       na.rm = TRUE),
         NTrials = n()
         ) %>% 
  # Now we only need one row per subject
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(MoMTrialDuration = mean(MeanTrialDuration,
                       na.rm = TRUE),
         MoMSAP = mean(MeanSAP,
                       na.rm = TRUE),
         MoMIRI = mean(MeanIRI),
         sdSAP = sd(TrialSAP),
         sdMeanIRI = sd(MeanIRI),
         sdTD = sd(TrialDuration)
  ) %>% 
  # Make table
  select(Subject, InsightTrialType, NTrials, MeanSAP,MoMSAP,sdSAP,
         MeanTrialDuration, MoMTrialDuration,sdTD, MeanIRI, MoMIRI, sdMeanIRI) %>% 
  kable(format = "html",
        caption = "4E - Performance in Trials w/o Portal Use") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
```{r 4E_non_vs_portal_usage_ttest, echo=FALSE}
# Info for trials w/ portal entry
portal_used_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 0) %>% 
  mutate(TrialSAP = max(MoveCounter) - TrialPar) %>% 
  # We now only need one row per trial 
  filter(row_number() == 1) %>% 
  ungroup()

portal_NOT_used_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0),
         DidEnterPortal = max(DidEnterPortal)) %>% 
  filter(DidEnterPortal == 1) %>% 
  mutate(TrialSAP = max(MoveCounter) - TrialPar) %>% 
  # We now only need one row per trial 
  filter(row_number() == 1) %>% 
  ungroup()

print(t.test(portal_used_data$TrialSAP,
             portal_NOT_used_data$TrialSAP,
             var.equal = FALSE))

```
```{r 4E_non_vs_portal_usage_graphic, echo=FALSE}
# Info for trials w/ portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal),
         TextDidEnterPortal = ifelse(DidEnterPortal == 1,
                                     "Portal",
                                     "Direct"),
         TrialSAP = max(MoveCounter) - TrialPar,
         ) %>% 
  filter(row_number() == 1) %>% 
  group_by(Subject, TextDidEnterPortal) %>% 
  mutate(meanSAP = mean(TrialSAP,
                        na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(TextDidEnterPortal) %>% 
  mutate(MoMSAP = mean(meanSAP),
         sdSAP = sd(meanSAP)) %>% 
  ungroup() %>% 
  # Build graphic
  ggplot(aes(y = MoMSAP,
             x = TextDidEnterPortal,
             fill = TextDidEnterPortal)) + 
  geom_bar(stat = "identity",
         position = "dodge",
         width = 0.7,
         color = "black") +
  geom_errorbar(aes(ymin = MoMSAP,
                    ymax = MoMSAP + sdSAP),
                position = position_dodge(width = 0.15),
                width = 0.2
                ) +
      # Aesthetics
  theme_classic() +
  labs(title = "Exp 4.e - Efficiency Across Portal Use",
       y = "Mean SAP",
       x = "Trial Par",
       fill = "Tactic") +
  scale_fill_manual(values = c("darkorange3", "seagreen4")) +
  scale_y_continuous(breaks = integer_breaks()) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()
  )

```
```{r 4E_non_vs_portal_usage_by_subject_graphic, echo=FALSE}
# Info for trials w/ portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal),
         TextDidEnterPortal = ifelse(DidEnterPortal == 1,
                                     "Portal",
                                     "Direct"),
         TrialSAP = max(MoveCounter) - TrialPar,
         ) %>% 
  filter(row_number() == 1) %>% 
  group_by(Subject, TextDidEnterPortal) %>% 
  mutate(meanSAP = mean(TrialSAP,
                        na.rm = TRUE),
         sdSAP = sd(TrialSAP)) %>% 
  ungroup() %>% 
  # Build graphic
  ggplot(aes(y = meanSAP,
             x = TextDidEnterPortal,
             fill = TextDidEnterPortal)) + 
  geom_bar(stat = "identity",
         position = "dodge",
         width = 0.7,
         color = "black") +
  geom_errorbar(aes(ymin = meanSAP,
                    ymax = meanSAP + sdSAP),
                position = position_dodge(width = 0.15),
                width = 0.2
                ) +
  facet_wrap(vars(Subject)) +
      # Aesthetics
  theme_classic() +
  labs(title = "Exp 4.e - Efficiency Across Portal Use",
       y = "Mean SAP",
       x = "Trial Par",
       fill = "Tactic") +
  scale_fill_manual(values = c("darkorange3", "seagreen4")) +
  scale_y_continuous(breaks = integer_breaks()) +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15)),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()
  )

```
```{r 4E_portal_entrance_ratios_graphic2, echo=FALSE}
# Percentage of sessions with portal entry
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  group_by(Subject, TrialNum) %>% 
  mutate(DidEnterPortal = ifelse(EventType == "PortalActivated",
                                 1,
                                 0
                                 ),
         DidEnterPortal = max(DidEnterPortal),
         TextDidEnterPortal = ifelse(DidEnterPortal == 1,
                                     "Y",
                                     "N")
         ) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(MeanDidEnterPortal = mean(DidEnterPortal,
                                       na.rm = TRUE)) %>% 
  ungroup() %>% 
  #build graphic
  ggplot(aes(x = Subject,
             y = MeanDidEnterPortal)) + 
  geom_bar(stat = "identity",
         position = "dodge",
         width = 0.7,
         color = "black",
         fill = "seagreen4") +
  geom_hline(yintercept = 0.5,
             linetype = "dashed") +
  ylim(0, 1) +
      # Aesthetics
  theme_classic() +
  labs(title = "Exp 4.e - Portal Discrimination",
       y = "Ratio Trials w/ Portal Use") +
  theme(
    plot.title = element_text(family = "Times", face = "bold", size = (20)),
    axis.title = element_text(family = "Times", size = (20)),
    axis.text = element_text(family = "Times", face = "italic", size = (15)),
    legend.text = element_text(family = "Times", size = (15)),
    legend.title = element_text(family = "Times", face = "bold", size = (15))
  )
  
  
```

```{r 4E_vs_2Test, echo=FALSE}
fiveTEST_data <- combined_data %>%
  filter(TrainingPhase %in% c("5 TEST"),
         EventType %in% c("reinforcement"),
         TrialPar == 5
         ) %>%
  # First, remove any sessions with fewer than 5 completed trials
  group_by(Subject, Date) %>% 
  mutate(MaxTrialsCompleted = max(TrialNum)) %>% 
  filter(MaxTrialsCompleted >= 5) %>% 
  ungroup() %>% 
  # Assign a session number to each and find max
  group_by(Subject) %>% 
  mutate(SessionNum = dense_rank(Date),
         MaxSession = max(SessionNum)) %>% 
  # Then select the terminal three sessions
  filter(SessionNum %in% c(MaxSession)) %>% 
  # Find SAP for each trial...
  group_by(Subject, SessionNum, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

fourE_data <-combined_data %>%
  filter(TrainingPhase %in% c("7 TEST"),
         InsightTrialType == "7.5",
         EventType %in% c("reinforcement")) %>%
  # Find SAP for each trial...
  group_by(Subject, Date, TrialNum) %>% 
  mutate(SAP = MoveCounter - TrialPar) %>% # Variable par
  ungroup()

# Print a t-test w/ equal variances
print(t.test(fiveTEST_data$SAP,
             fourE_data$SAP,
             var.equal = FALSE))
```

### 4E GLMs
#### 4E GLM for SAP
```{r 4E_GLM_SAP, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialSap)

glm_model <- glm(TrialSap ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4E_ind_GLM_SAP, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialSap = max(MoveCounter) - TrialPar - 1) %>% # Phase 4 trial SAP was off by 1
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialSap, TrialNum, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    SAP_GLM_Slope = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    SAP_GLM_SE = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    SAP_GLM_Tval = coef(summary(glm(TrialSap ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    SAP_GLM_Sig = coef(summary(glm(TrialSap ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, SAP_GLM_Slope, SAP_GLM_SE,
         SAP_GLM_Tval, SAP_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4E: w/in Subject SAP GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```
#### 4E GLM for Trial Completion Time
```{r 4E_GLM_TCT, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, TrialDuration)

glm_model <- glm(TrialDuration ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4E_ind_GLM_TCT, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(TrialDuration = as.numeric(max(TrialTime))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, TrialDuration, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    TCT_GLM_Slope = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    TCT_GLM_SE = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    TCT_GLM_Tval = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    TCT_GLM_Sig = coef(summary(glm(TrialDuration ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, TCT_GLM_Slope, TCT_GLM_SE,
         TCT_GLM_Tval, TCT_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4E: w/in Subject TCT GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

#### 4E GLM for Inter-Response Intervals
```{r 4E_GLM_IRI, echo=FALSE}
GLM_data <- combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  # Take one row from each trial
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  group_by(Subject) %>% 
  mutate(KeyTrialCounter = dense_rank(TrialNum)) %>% 
  select(Subject, KeyTrialCounter, MeanTrialIRI)

glm_model <- glm(MeanTrialIRI ~ KeyTrialCounter, 
              data = GLM_data)

summary(glm_model)
```
```{r 4E_ind_GLM_IRI, echo=FALSE}
combined_data %>%
  filter(TrainingPhase == "7 TEST",
         InsightTrialType == "7.5",
         Subject %in% c("Herriot",
                        "Wario",
                        "Yoshi")
         ) %>%
  # Reorder trials in consecutive order...
  group_by(Subject) %>% 
  mutate(OrderedTrial = dense_rank(TrialNum)) %>% 
  # Assign a session number to each and find max
  group_by(Subject, TrialNum) %>% 
  mutate(IRI = TrialTime - lag(TrialTime),
         MeanTrialIRI = as.numeric(mean(IRI,
                                        na.rm = TRUE))) %>% 
  filter(row_number() == 1) %>%  # One data point for each trial
  # Take one row from each trial
  select(Subject, InsightTrialType, MeanTrialIRI, OrderedTrial) %>% 
  group_by(Subject) %>% 
  mutate(
    # First the slope of the correlation
    IRI_GLM_Slope = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[2],
    # Second the SE
    IRI_GLM_SE = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[4],
    # Third the t-value
    IRI_GLM_Tval = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                     data = cur_data())))[6],
    # Last the significance for each subject
    IRI_GLM_Sig = coef(summary(glm(MeanTrialIRI ~ OrderedTrial,
                                   data = cur_data())))[8],
    # Max Number of trials
    MaxTrials = max(OrderedTrial)
    ) %>% 
  filter(row_number() == 1) %>% # One data point for each subject
  select(Subject, InsightTrialType, MaxTrials, IRI_GLM_Slope, IRI_GLM_SE,
         IRI_GLM_Tval, IRI_GLM_Sig) %>% 
  kable(format = "html",
      caption = "4E: w/in Subject IRI GLM") %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = "striped")
```

```{r anim_test, echo=FALSE}
anim <- ggplot(iris, aes(Sepal.Width, Petal.Width)) +
  geom_point() +
  labs(title = "{closest_state}") +
  transition_states(Species, transition_length = 3, state_length = 1)
```


